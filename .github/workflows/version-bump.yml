name: Version Bump AutomÃ¡tico

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Tipo de bump de versiÃ³n'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  bump-version:
    runs-on: ubuntu-latest
    # Ejecutar si:
    # 1. PR fue mergeado Y tiene label de versiÃ³n, O
    # 2. Push directo a main/master con mensaje que contiene [version:bump], O
    # 3. Workflow manual
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[version:bump]')) ||
      github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Determinar tipo de bump
        id: version-bump
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Workflow manual: usar input directamente
            echo "type=${{ github.event.inputs.version_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            # Push directo: revisar mensaje de commit para [version:bump:major/minor/patch]
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "Mensaje de commit: $COMMIT_MSG"
            
            if echo "$COMMIT_MSG" | grep -qi "\[version:bump:major\]\|\[version:major\]"; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif echo "$COMMIT_MSG" | grep -qi "\[version:bump:minor\]\|\[version:minor\]"; then
              echo "type=minor" >> $GITHUB_OUTPUT
            elif echo "$COMMIT_MSG" | grep -qi "\[version:bump:patch\]\|\[version:patch\]"; then
              echo "type=patch" >> $GITHUB_OUTPUT
            else
              # Si no hay tag explÃ­cito en commit, no hacer bump (salir silenciosamente)
              echo "âš ï¸ Commit sin tag de versiÃ³n [version:bump:*], saltando bump"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            # Pull Request: revisar labels del PR
            LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
            echo "Labels encontrados: $LABELS"
            
            if echo "$LABELS" | grep -qi "version:major\|major-version\|breaking"; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif echo "$LABELS" | grep -qi "version:minor\|minor-version\|feature"; then
              echo "type=minor" >> $GITHUB_OUTPUT
            elif echo "$LABELS" | grep -qi "version:patch\|patch-version\|bugfix\|fix"; then
              echo "type=patch" >> $GITHUB_OUTPUT
            else
              # Por defecto, patch si no hay label explÃ­cito
              echo "type=patch" >> $GITHUB_OUTPUT
              echo "âš ï¸ No se encontrÃ³ label de versiÃ³n, usando 'patch' por defecto"
            fi
          fi

      - name: Leer versiÃ³n actual
        id: current-version
        run: |
          # Leer versiÃ³n desde src/__version__.py (fuente de verdad principal)
          CURRENT_VERSION=$(grep -E '^__version__\s*=' src/__version__.py | sed -E "s/.*['\"]([^'\"]+)['\"].*/\1/")
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION="4.1.0"  # Fallback
          fi
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ VersiÃ³n actual: $CURRENT_VERSION"
          
          # Parsear versiÃ³n
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

      - name: Calcular nueva versiÃ³n
        id: new-version
        run: |
          BUMP_TYPE="${{ steps.version-bump.outputs.type }}"
          CURRENT_MAJOR="${{ steps.current-version.outputs.major }}"
          CURRENT_MINOR="${{ steps.current-version.outputs.minor }}"
          CURRENT_PATCH="${{ steps.current-version.outputs.patch }}"
          
          case $BUMP_TYPE in
            major)
              NEW_MAJOR=$((CURRENT_MAJOR + 1))
              NEW_MINOR=0
              NEW_PATCH=0
              ;;
            minor)
              NEW_MAJOR=$CURRENT_MAJOR
              NEW_MINOR=$((CURRENT_MINOR + 1))
              NEW_PATCH=0
              ;;
            patch)
              NEW_MAJOR=$CURRENT_MAJOR
              NEW_MINOR=$CURRENT_MINOR
              NEW_PATCH=$((CURRENT_PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "major=$NEW_MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$NEW_MINOR" >> $GITHUB_OUTPUT
          echo "patch=$NEW_PATCH" >> $GITHUB_OUTPUT
          echo "ðŸš€ Nueva versiÃ³n: $NEW_VERSION (bump: $BUMP_TYPE)"

      - name: Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Instalar herramientas necesarias
        run: |
          # Instalar jq para manejar JSON si no estÃ¡ disponible
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Actualizar versiones en archivos
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.version }}"
          NEW_MAJOR="${{ steps.new-version.outputs.major }}"
          NEW_MINOR="${{ steps.new-version.outputs.minor }}"
          NEW_PATCH="${{ steps.new-version.outputs.patch }}"
          
          echo "ðŸ“ Actualizando versiones en archivos..."
          
          # 1. src/__version__.py
          sed -i "s/^__version__ = \".*\"/__version__ = \"$NEW_VERSION\"/" src/__version__.py
          sed -i "s/^__version_info__ = (.*)/__version_info__ = ($NEW_MAJOR, $NEW_MINOR, $NEW_PATCH)/" src/__version__.py
          echo "  âœ… src/__version__.py actualizado a $NEW_VERSION"
          
          # 2. src/engines/__version__.py
          if [ -f "src/engines/__version__.py" ]; then
            sed -i "s/^ENGINE_VERSION = \".*\"/ENGINE_VERSION = \"$NEW_VERSION\"/" src/engines/__version__.py
            echo "  âœ… src/engines/__version__.py actualizado a $NEW_VERSION"
          fi
          
          # 3. src/cpp_core/include/version.h
          if [ -f "src/cpp_core/include/version.h" ]; then
            sed -i "s/^#define ATHERIA_NATIVE_VERSION_MAJOR .*/#define ATHERIA_NATIVE_VERSION_MAJOR $NEW_MAJOR/" src/cpp_core/include/version.h
            sed -i "s/^#define ATHERIA_NATIVE_VERSION_MINOR .*/#define ATHERIA_NATIVE_VERSION_MINOR $NEW_MINOR/" src/cpp_core/include/version.h
            sed -i "s/^#define ATHERIA_NATIVE_VERSION_PATCH .*/#define ATHERIA_NATIVE_VERSION_PATCH $NEW_PATCH/" src/cpp_core/include/version.h
            sed -i "s/^#define ATHERIA_NATIVE_VERSION_STRING \".*\"/#define ATHERIA_NATIVE_VERSION_STRING \"$NEW_VERSION\"/" src/cpp_core/include/version.h
            echo "  âœ… src/cpp_core/include/version.h actualizado a $NEW_VERSION"
          fi
          
          # 4. frontend/package.json
          if [ -f "frontend/package.json" ]; then
            # Usar jq para manejar JSON correctamente
            jq ".version = \"$NEW_VERSION\"" frontend/package.json > frontend/package.json.tmp && mv frontend/package.json.tmp frontend/package.json
            echo "  âœ… frontend/package.json actualizado a $NEW_VERSION"
          fi
          
          echo "âœ… Todas las versiones actualizadas a $NEW_VERSION"

      - name: Verificar cambios
        run: |
          echo "ðŸ“‹ Verificando cambios en archivos de versiÃ³n:"
          git diff --name-only
          echo ""
          echo "ðŸ“ Cambios detallados:"
          git diff || true

      - name: Crear commit con versiones actualizadas
        run: |
          git add -A
          git commit -m "chore: bump version to ${{ steps.new-version.outputs.version }} [skip ci]"
          
          # Push del commit
          git push origin HEAD:main || git push origin HEAD:master

      - name: Crear tag de versiÃ³n
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.version }}"
          git tag -a "v${NEW_VERSION}" -m "Release version ${NEW_VERSION}"
          git push origin "v${NEW_VERSION}"
          echo "ðŸ·ï¸  Tag v${NEW_VERSION} creado y pusheado"

      - name: Crear Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.new-version.outputs.version }}
          name: "Release v${{ steps.new-version.outputs.version }}"
          body: |
            ## ðŸš€ Release v${{ steps.new-version.outputs.version }}
            
            **Tipo de bump:** ${{ steps.version-bump.outputs.type }}
            
            ### ðŸ“ Cambios
            ${{ github.event.pull_request.body || 'Ver commits para detalles' }}
            
            ### ðŸ“¦ Componentes actualizados
            - âœ… Backend Python: v${{ steps.new-version.outputs.version }}
            - âœ… Motor Nativo C++: v${{ steps.new-version.outputs.version }}
            - âœ… Frontend React: v${{ steps.new-version.outputs.version }}
            
          draft: false
          prerelease: false

      - name: Resumen
        run: |
          echo "## âœ… VersiÃ³n actualizada exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **VersiÃ³n anterior:** ${{ steps.current-version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Nueva versiÃ³n:** ${{ steps.new-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tipo de bump:** ${{ steps.version-bump.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag creado:** v${{ steps.new-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

