# .github/workflows/ci.yml

name: Continuous Integration (CI)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to commit and push auto-fixes
      pull-requests: write # Needed to comment on the PR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Detectar cambios en Frontend
        id: check-frontend
        run: |
          echo "Detectando cambios en frontend/..."

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            files=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
              jq -r '.[].filename')
          else
            # Push directo: comparar con commit anterior
            files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          has_frontend_changes=false
          for file in $files; do
            if [[ "$file" == frontend/* ]]; then
              has_frontend_changes=true
              break
            fi
          done

          if $has_frontend_changes; then
            echo "‚úÖ Detectados cambios en frontend/"
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  No hay cambios en frontend/, saltando build"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Lint Frontend
        id: lint
        if: steps.check-frontend.outputs.skip != 'true'
        run: npm run lint --prefix frontend
        continue-on-error: true

      - name: Auto-fix Lint Errors
        id: auto-fix
        if: steps.lint.outcome == 'failure' && steps.check-frontend.outputs.skip != 'true'
        run: |
          echo "‚ö†Ô∏è Lint check failed. Attempting to auto-fix..."
          npm run lint --prefix frontend -- --fix

      - name: Commit and Request Review
        id: commit-and-review
        if: steps.auto-fix.outcome == 'success' && steps.check-frontend.outputs.skip != 'true'
        run: |
          # Check if there are any changes to commit
          if ! git diff --quiet --exit-code; then
            echo "üìù Auto-fix applied changes. Committing, pushing, and requesting review..."
            git add .
            git commit -m "chore(lint): apply automatic lint fixes [by Atheria CI]"
            git push

            # Post a comment to trigger a new review
            gh pr comment ${{ github.event.pull_request.number }} --body "I've applied automatic lint fixes. Requesting a new review: @gemini-cli /review"

            # Fail the job to stop the current run and let the new pushed commit trigger a new CI run
            echo "Failing this run to allow the new commit to trigger a fresh CI check."
            exit 1
          else
            echo "‚ùå Auto-fix did not produce any changes, but lint is still failing. Manual intervention required."
            # Fail the job to indicate that auto-fix was not successful
            exit 1
          fi

      - name: Build Frontend
        id: build_frontend
        if: steps.check-frontend.outputs.skip != 'true'
        run: npm run build > build_output.log 2>&1
        working-directory: ./frontend
        continue-on-error: true

      - name: Upload Frontend Build Log
        if: steps.build_frontend.outcome == 'failure' && steps.check-frontend.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-log
          path: frontend/build_output.log

      - name: Report Frontend Build Failure
        if: steps.build_frontend.outcome == 'failure' && github.event_name == 'pull_request' && steps.check-frontend.outputs.skip != 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('frontend/build_output.log', 'utf8');
            const commentBody = `
            ## ‚ùå Frontend Build Failed

            The \`npm run build\` command failed during the CI check.

            <details>
            <summary>Click to view the build log</summary>

            \`\`\`
            ${output}
            \`\`\`
            </details>

            Please review the log above to identify and fix the issue.
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Check Build Status
        if: steps.build_frontend.outcome == 'failure' && steps.check-frontend.outputs.skip != 'true'
        run: |
          echo "Frontend build failed. See the artifact and the PR comment for details."
          exit 1

      - name: Detectar cambios en Backend
        id: check-backend
        run: |
          echo "Detectando cambios en backend..."

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            files=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" | \
              jq -r '.[].filename')
          else
            # Push directo: comparar con commit anterior
            files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          has_backend_changes=false
          for file in $files; do
            if [[ "$file" == src/* ]] || [[ "$file" == setup.py ]] || [[ "$file" == pyproject.toml ]] || [[ "$file" == CMakeLists.txt ]]; then
              has_backend_changes=true
              break
            fi
          done

          # Verificar si el commit pide build expl√≠cito
          COMMIT_MSG=$(git log -1 --format="%B" HEAD)
          if echo "$COMMIT_MSG" | grep -qi "\[build:backend\]"; then
            has_backend_changes=true
            echo "‚úÖ Commit solicita build de backend expl√≠cito"
          fi

          if $has_backend_changes; then
            echo "‚úÖ Detectados cambios en backend/"
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è  No hay cambios en backend/, saltando build"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi


      - name: Install PyTorch (required for LibTorch)
        if: steps.check-backend.outputs.skip != 'true'
        run: |
          echo "üì¶ Instalando PyTorch para LibTorch..."
          pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Install Backend Dependencies
        if: steps.check-backend.outputs.skip != 'true'
        run: |
          echo "üì¶ Instalando dependencias del backend..."
          pip install -e .
        continue-on-error: true

      - name: Build C++ Extensions
        if: steps.check-backend.outputs.skip != 'true'
        run: python setup.py build_ext --inplace
        continue-on-error: true

      - name: Run Backend Tests
        if: steps.check-backend.outputs.skip != 'true'
        run: pytest
        continue-on-error: true
