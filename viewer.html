<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visor/Controlador AETHERIA</title>
    <style>
        body { font-family: system-ui, sans-serif; display: grid; grid-template-columns: 300px 1fr; gap: 1rem; min-height: 95vh; background: #111; color: #eee; margin: 0; padding: 1rem; }
        #controls { background: #1a1a1a; border: 1px solid #444; padding: 1rem; border-radius: 10px; display: flex; flex-direction: column; gap: 1rem; }
        #viewer { text-align: center; }
        h1 { font-weight: 300; margin-top: 0; }
        #simCanvas {
            width: 100%;
            height: auto;
            max-height: 85vh;
            aspect-ratio: 1 / 1;
            background: #000;
            border: 1px solid #555;
            image-rendering: pixelated; 
        }
        #status { font-size: 1.1rem; margin-top: 0.5rem; }
        #status.connected { color: #4ade80; }
        #status.error { color: #f87171; }
        #stepCounter { color: #aaa; }
        
        button, select {
            font-size: 1rem;
            padding: 0.75rem;
            background: #333;
            color: #eee;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #444; }
        button:active { background: #555; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    </style>
</head>
<body>
    <div id="controls">
        <h1>Controles AETHERIA</h1>
        
        <div id="status">Conectando...</div>
        <div id="stepCounter">Paso: 0</div>
        
        <hr>
        
        <label for="viz_select">Tipo de Visualizaci贸n:</label>
        <select id="viz_select" onchange="sendVizChange()">
            <option value="change">Cambio de Estado (change)</option>
            <option value="density">Densidad (density)</option>
            <option value="phase">Fase (phase)</option>
            <option value="magnitude">Magnitud (magnitude)</option>
            <option value="channels">Canales (channels)</option>
        </select>
        
        <hr>

        <div class="button-group">
            <button onclick="sendCommand({command: 'pause'})">革 Pausar</button>
            <button onclick="sendCommand({command: 'resume'})">讹 Reanudar</button>
        </div>
        
        <button onclick="sendCommand({command: 'reset'})"> Resetear Simulaci贸n</button>
        
    </div>
    
    <div id="viewer">
        <canvas id="simCanvas" width="512" height="512"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const stepCounterEl = document.getElementById('stepCounter');
        const vizSelect = document.getElementById('viz_select');
        
        // --- 隆隆CONFIGURACIN MANUAL!! ---
        // 1. Pega la URL del puerto 8765 de tu Studio.
        // 2. CAMBIA 'https://' por 'wss://'.
        // const WEBSOCKET_URL = "wss://8765-01k95p45n43bdtt9r4rzw4a5z1.cloudspaces.litng.ai"; // <-- 隆隆EDITA ESTA LNEA!!
        const WEBSOCKET_URL = "ws://localhost:8765"; // <-- 隆隆EDITA ESTA LNEA!!
        
        let ws; // Variable global para la conexi贸n WebSocket

        const img = new Image();
        
        img.onload = () => {
            if (canvas.width !== img.width || canvas.height !== img.height) {
                canvas.width = img.width;
                canvas.height = img.height;
            }
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };

        function connect() {
            if (!WEBSOCKET_URL) {
                statusEl.textContent = "Error: URL no configurada en viewer.html";
                statusEl.className = "error";
                return;
            }
            
            console.log("Intentando conectar a:", WEBSOCKET_URL);
            ws = new WebSocket(WEBSOCKET_URL);

            ws.onopen = () => {
                console.log("Conectado al servidor AETHERIA.");
                statusEl.textContent = "Conectado";
                statusEl.className = "connected";
                sendVizChange(); // Sincroniza el selectbox al conectar
            };

            ws.onclose = () => {
                console.log("Desconectado del servidor. Reintentando en 3s...");
                statusEl.textContent = "Desconectado. Reintentando...";
                statusEl.className = "error";
                setTimeout(connect, 3000); // Reintentar conexi贸n
            };

            ws.onerror = (err) => {
                console.error("Error de WebSocket:", err);
                statusEl.textContent = "Error de conexi贸n.";
                statusEl.className = "error";
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    stepCounterEl.textContent = `Paso: ${data.step} (Tipo: ${data.frame_type})`;
                    
                    if (vizSelect.value !== data.frame_type) {
                        vizSelect.value = data.frame_type;
                    }
                    
                    img.src = data.image_data;
                } catch (e) {
                    console.error("Error procesando mensaje:", e, event.data);
                }
            };
        }

        // --- Funciones de Control que env铆an JSON ---
        
        function sendCommand(cmd) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log("Enviando comando:", cmd);
                ws.send(JSON.stringify(cmd));
            } else {
                console.warn("No se pudo enviar el comando, WebSocket no est谩 abierto.");
            }
        }
        
        function sendVizChange() {
            const vizType = vizSelect.value;
            sendCommand({
                command: "set_viz",
                type: vizType
            });
        }
        
        // --- Iniciar conexi贸n al cargar la p谩gina ---
        connect();

    </script>
</body>
</html>