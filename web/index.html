<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Aetheria Lab</title>
    <style>
        body { 
            font-family: system-ui, sans-serif; 
            display: grid; 
            grid-template-columns: 300px 1fr 350px; /* Controles | Visor | Datos/Entrenamiento */
            gap: 1rem; 
            min-height: 95vh; 
            background: #111; 
            color: #eee; 
            margin: 0; 
            padding: 1rem; 
        }
        .panel { 
            background: #1a1a1a; 
            border: 1px solid #444; 
            padding: 1rem; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
        }
        #viewer { text-align: center; }
        h1, h2 { font-weight: 300; margin-top: 0; color: #00aaff; }
        h2 { font-size: 1.2rem; border-bottom: 1px solid #444; padding-bottom: 0.5rem; margin-bottom: 0.5rem;}

        #main_canvas {
            width: 100%;
            height: auto;
            max-height: 85vh;
            aspect-ratio: 1 / 1;
            background: #000;
            border: 1px solid #555;
            image-rendering: pixelated; 
            cursor: grab;
        }
        #main_canvas:active { cursor: grabbing; }
        #status { font-size: 1.1rem; margin-top: 0.5rem; }
        #status.connected { color: #4ade80; }
        #status.error { color: #f87171; }
        #stepCounter { color: #aaa; }
        
        button, select, input[type="number"], input[type="text"] {
            font-size: 1rem;
            padding: 0.75rem;
            background: #333;
            color: #eee;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background: #444; }
        button:active { background: #555; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }

        #data-panel .metric, #config-panel .config-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            padding: 4px 0;
        }
        #data-panel .metric-label, #config-panel .config-label { color: #aaa; }
        #data-panel .metric-value, #config-panel .config-value { color: #00aaff; font-weight: bold; }

        #training-log {
            background: #000;
            color: #00ff7f;
            font-family: monospace;
            font-size: 0.8em;
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #444;
            padding: 5px;
            white-space: pre-wrap;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        .form-group label {
            font-size: 0.9rem;
            color: #ccc;
        }
        input[type="text"], input[type="number"] {
            cursor: text;
        }
    </style>
</head>
<body>
    <div id="controls" class="panel">
        <h1>Controles de Simulaci贸n</h1>
        
        <div id="status">Conectando...</div>
        <div id="stepCounter">Paso: 0</div>
        
        <hr>
        
        <label for="viz_select">Tipo de Visualizaci贸n:</label>
        <select id="viz_select" onchange="sendVizChange()">
            <optgroup label="An谩lisis de Grid">
                <option value="density">Densidad</option>
                <option value="state_change">Magnitud del Cambio</option>
                <option value="channels">Canales RGB</option>
                <option value="aggregate_phase">Fase Agregada</option>
                <option value="fft">Transformada de Fourier 2D</option>
            </optgroup>
            <optgroup label="An谩lisis Temporal y Estad铆stico">
                <option value="spacetime_slice">Diagrama Espacio-Tiempo</option>
                <option value="spacetime_cube">Cubo Espacio-Tiempo</option>
                <option value="poincare">Gr谩fico de Poincar茅</option>
                <option value="density_histogram">Histograma de Densidad</option>
            </optgroup>
        </select>
        
        <hr>

        <div class="button-group">
            <button onclick="sendCommand({scope: 'sim', command: 'pause'})">革 Pausar</button>
            <button onclick="sendCommand({scope: 'sim', command: 'resume'})">讹 Reanudar</button>
        </div>
        
        <button onclick="handleReset()"> Resetear Simulaci贸n</button>

        <hr>
        <h2>Cargar Modelo para Simulaci贸n</h2>
        <div class="form-group">
            <label for="model_select">Modelo:</label>
            <select id="model_select">
                <option value="">(Estado Inicial Aleatorio)</option>
            </select>
        </div>
        <button onclick="startSimulation()">讹 Iniciar Simulaci贸n</button>
        <button onclick="stopSimulation()"> Detener Simulaci贸n</button>
        
    </div>
    
    <div id="viewer">
        <canvas id="main_canvas" width="512" height="512"></canvas>
    </div>

    <div id="data-training-panel" class="panel">
        <h2>M茅tricas Globales</h2>
        <div class="metric">
            <span class="metric-label">Entrop铆a (Grid):</span>
            <span id="metric_entropy" class="metric-value">...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Densidad Media:</span>
            <span id="metric_mean_density" class="metric-value">...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Varianza Densidad:</span>
            <span id="metric_variance" class="metric-value">...</span>
        </div>

        <hr>
        <h2>Configuraci贸n de Simulaci贸n</h2>
        <div id="sim_config_display">
            <div class="config-item"><span class="config-label">Modelo:</span> <span id="sim_config_model" class="config-value">N/A</span></div>
            <div class="config-item"><span class="config-label">Tama帽o Grilla:</span> <span id="sim_config_grid_size" class="config-value">N/A</span></div>
            <div class="config-item"><span class="config-label">Dim. Estado (D):</span> <span id="sim_config_d_state" class="config-value">N/A</span></div>
            <div class="config-item"><span class="config-label">Arquitectura:</span> <span id="sim_config_arch" class="config-value">N/A</span></div>
            <div class="config-item"><span class="config-label">Dispositivo:</span> <span id="sim_config_device" class="config-value">N/A</span></div>
        </div>

        <hr>
        <h1>Controles de Entrenamiento</h1>
        <div class="form-group">
            <label for="exp_name">Nombre Experimento:</label>
            <input type="text" id="exp_name" value="NuevoExperimento">
        </div>
        <div class="form-group">
            <label for="train_model_type">Tipo Modelo:</label>
            <select id="train_model_type">
                <option value="unet">U-Net (Est谩ndar)</option>
                <option value="unet_unitary">U-Net (Unitario)</option>
                <option value="mlp">MLP</option>
            </select>
        </div>
        <div class="form-group">
            <label for="hidden_channels">Canales Ocultos:</label>
            <input type="number" id="hidden_channels" value="32" min="1">
        </div>
        <div class="form-group">
            <label for="learning_rate">Tasa de Aprendizaje:</label>
            <input type="number" id="learning_rate" value="0.000001" step="0.000001">
        </div>
        <div class="form-group">
            <label for="episodes">Episodios:</label>
            <input type="number" id="episodes" value="2000" min="1">
        </div>
        <button onclick="startTraining()"> Iniciar Entrenamiento</button>
        <button onclick="stopTraining()"> Detener Entrenamiento</button>
        <button onclick="refreshCheckpoints()"> Refrescar Modelos</button>

        <hr>
        <h2>Log de Entrenamiento</h2>
        <pre id="training-log"></pre>
    </div>

    <script>
        // --- ESTADO PRINCIPAL Y CONEXIN ---
        const canvas = document.getElementById('main_canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const stepCounterEl = document.getElementById('stepCounter');
        const vizSelect = document.getElementById('viz_select');
        const modelSelect = document.getElementById('model_select');
        const trainingLog = document.getElementById('training-log');

        const simConfigModel = document.getElementById('sim_config_model');
        const simConfigGridSize = document.getElementById('sim_config_grid_size');
        const simConfigDState = document.getElementById('sim_config_d_state');
        const simConfigArch = document.getElementById('sim_config_arch');
        const simConfigDevice = document.getElementById('sim_config_device');
        
        const proto = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const WEBSOCKET_URL = `${proto}//${host}/ws`;
        
        let ws; 
        const img = new Image();
        
        img.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };

        function connect() {
            console.log("Intentando conectar a:", WEBSOCKET_URL);
            statusEl.textContent = `Conectando a ${WEBSOCKET_URL}...`;
            ws = new WebSocket(WEBSOCKET_URL);

            ws.onopen = () => {
                console.log("Conectado al servidor AETHERIA.");
                statusEl.textContent = "Conectado";
                statusEl.className = "connected";
                sendVizChange(); 
                sendViewportChange();
            };

            ws.onclose = () => {
                console.log("Desconectado del servidor. Reintentando en 3s...");
                statusEl.textContent = "Desconectado. Reintentando...";
                statusEl.className = "error";
                setTimeout(connect, 3000);
            };

            ws.onerror = (err) => {
                console.error("Error de WebSocket:", err);
                statusEl.textContent = "Error de conexi贸n.";
                statusEl.className = "error";
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'sim_update') {
                        stepCounterEl.textContent = `Paso: ${data.step} (Tipo: ${data.frame_type})`;
                        if (vizSelect.value !== data.frame_type) {
                            vizSelect.value = data.frame_type;
                        }
                        img.src = data.image_data;

                        if (data.metrics) {
                            document.getElementById('metric_entropy').textContent = data.metrics.entropy.toFixed(4);
                            document.getElementById('metric_mean_density').textContent = data.metrics.mean_density.toFixed(4);
                            document.getElementById('metric_variance').textContent = data.metrics.variance.toFixed(4);
                        }
                    } else if (data.type === 'init' || data.type === 'checkpoints') {
                        updateModelSelect(data.checkpoints.training_models);
                        if (data.sim_config) {
                            updateSimConfigDisplay(data.sim_config);
                        }
                    } else if (data.type === 'training_log') {
                        trainingLog.textContent += data.data + '\n';
                        trainingLog.scrollTop = trainingLog.scrollHeight;
                    } else if (data.type === 'sim_status' && data.status === 'running') {
                        updateSimConfigDisplay(data.config);
                    } else if (data.type === 'sim_status' && data.status === 'stopped') {
                        updateSimConfigDisplay({}); // Limpiar config
                    } else if (data.type === 'status') {
                        trainingLog.textContent += `--- ${data.data} ---\n`;
                        trainingLog.scrollTop = trainingLog.scrollHeight;
                    } else if (data.type === 'error') {
                        trainingLog.textContent += `ERROR: ${data.data}\n`;
                        trainingLog.scrollTop = trainingLog.scrollHeight;
                    }

                } catch (e) {
                    console.error("Error procesando mensaje:", e, event.data);
                }
            };
        }

        function sendCommand(cmd) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(cmd));
            } else {
                console.warn("No se pudo enviar el comando, WebSocket no est谩 abierto.");
            }
        }
        
        function sendVizChange() {
            const vizType = vizSelect.value;
            sendCommand({ scope: 'sim', command: "set_viz", args: { type: vizType } });
        }
        
        function handleReset() {
            viewport.x = 0;
            viewport.y = 0;
            viewport.width = 1;
            viewport.height = 1;
            sendCommand({scope: 'sim', command: 'reset'});
        }

        function updateModelSelect(models) {
            modelSelect.innerHTML = '<option value="">(Estado Inicial Aleatorio)</option>';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        }

        function updateSimConfigDisplay(config) {
            simConfigModel.textContent = config.model_path || 'N/A';
            simConfigGridSize.textContent = config.grid_size || 'N/A';
            simConfigDState.textContent = config.d_state || 'N/A';
            simConfigArch.textContent = config.model_architecture || 'N/A';
            simConfigDevice.textContent = config.device || 'N/A';
        }

        function startSimulation() {
            const selectedModel = modelSelect.value;
            sendCommand({ scope: 'sim', command: 'start', args: { model_path: selectedModel } });
        }

        function stopSimulation() {
            sendCommand({ scope: 'sim', command: 'stop' });
        }

        function startTraining() {
            const expName = document.getElementById('exp_name').value;
            const modelType = document.getElementById('train_model_type').value;
            const hiddenChannels = parseInt(document.getElementById('hidden_channels').value);
            const lr = parseFloat(document.getElementById('learning_rate').value);
            const episodes = parseInt(document.getElementById('episodes').value);

            sendCommand({ 
                scope: 'lab', 
                command: 'start_training', 
                args: { 
                    name: expName, 
                    model: modelType, 
                    hidden_channels: hiddenChannels, 
                    lr: lr, 
                    episodes: episodes 
                } 
            });
            trainingLog.textContent = ''; // Limpiar log al iniciar
        }

        function stopTraining() {
            sendCommand({ scope: 'lab', command: 'stop_training' });
        }

        function refreshCheckpoints() {
            sendCommand({ scope: 'lab', command: 'refresh_checkpoints' });
        }

        connect();
    </script>

    <script>
        // --- LGICA DE PAN Y ZOOM ---
        const viewport = { x: 0, y: 0, width: 1, height: 1 };
        const panning = { active: false, startX: 0, startY: 0 };
        const ZOOM_SENSITIVITY = 0.001;

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        const sendViewportChange = debounce(() => {
            sendCommand({ scope: 'sim', command: 'set_viewport', args: { viewport: viewport } });
        }, 100);

        canvas.addEventListener('mousedown', (e) => {
            panning.active = true;
            panning.startX = e.clientX;
            panning.startY = e.clientY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!panning.active) return;
            const dx = e.clientX - panning.startX;
            const dy = e.clientY - panning.startY;
            viewport.x -= (dx / canvas.clientWidth) * viewport.width;
            viewport.y -= (dy / canvas.clientHeight) * viewport.height;
            panning.startX = e.clientX;
            panning.startY = e.clientY;
            sendViewportChange();
        });

        const stopPanning = () => { panning.active = false; };
        canvas.addEventListener('mouseup', stopPanning);
        canvas.addEventListener('mouseleave', stopPanning);

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const mouseNormX = mouseX / canvas.clientWidth;
            const mouseNormY = mouseY / canvas.clientHeight;

            const zoomAmount = e.deltaY * ZOOM_SENSITIVITY;
            const zoomFactor = 1 + zoomAmount;
            
            const newWidth = viewport.width * zoomFactor;
            const newHeight = viewport.height * zoomFactor;

            if (newWidth < 0.001 || newWidth > 50) {
                return;
            }

            const focalX = viewport.x + mouseNormX * viewport.width;
            const focalY = viewport.y + mouseNormY * viewport.height;

            viewport.width = newWidth;
            viewport.height = newHeight;
            viewport.x = focalX - mouseNormX * newWidth;
            viewport.y = focalY - mouseNormY * newHeight;

            sendViewportChange();
        });
    </script>
</body>
</html>