<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Aetheria Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        :root {
            --bg-primary: #f6f8fa; /* Light GitHub background */
            --bg-secondary: #ffffff; /* White panel background */
            --text-primary: #24292e; /* Dark text */
            --text-secondary: #586069; /* Gray text */
            --border-color: #e1e4e8; /* Light gray border */
            --accent-blue: #0366d6; /* GitHub blue */
            --accent-green: #28a745; /* GitHub green for success */
            --accent-red: #cb2431; /* GitHub red for error */
            --shadow-color: rgba(27, 31, 35, 0.04); /* Subtle shadow */
            --code-bg: #f6f8fa; /* Code block background */
        }

        body { 
            font-family: 'Inter', sans-serif; /* Modern GitHub-like font */
            color: var(--text-primary); 
            min-height: 100vh; /* Ensure body takes full viewport height */
            margin: 0;
        }

        .container-fluid {
            min-height: 100vh; /* Ensure main container takes full height */
        }

        /* Custom styles for details/summary to mimic Bootstrap's card-header/body */
        details {
            border: none; /* Remove border */
            border-radius: 0; /* Remove border-radius */
            margin-bottom: 0.5rem; /* Smaller margin */
            background-color: transparent; /* Transparent background */
        }

        summary {
            display: block;
            padding: 0.5rem 0.75rem; /* Smaller padding */
            background-color: transparent; /* Transparent background */
            border-bottom: none; /* Remove border */
            border-radius: 0; /* Remove border-radius */
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        summary:hover {
            background-color: rgba(0, 0, 0, 0.05); /* Subtle hover effect */
        }

        details[open] summary {
            border-bottom: none;
        }

        details[open] summary {
            border-radius: 0;
        }

        .details-content {
            padding: 0.5rem 0.75rem 0.75rem; /* Adjust padding */
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* Smaller gap */
        }

        #main_canvas {
            width: 100%;
            height: auto;
            max-height: 85vh;
            aspect-ratio: 1 / 1;
            background: #000;
            border: 1px solid var(--border-color);
            box-shadow: none;
            image-rendering: pixelated; 
            cursor: grab;
        }
        #main_canvas:active { cursor: grabbing; }

        #status.connected { color: var(--accent-green); }
        #status.error { color: var(--accent-red); }
        #status.running { color: var(--accent-blue); }
        #status.paused { color: var(--text-secondary); }
        #status.stopped { color: var(--accent-red); }

        #training-log {
            height: 200px;
            overflow-y: scroll;
            font-size: 0.8em;
        }

        #experiments-sidebar .card-body {
            padding: 0; /* Remove padding from card body to allow list-group to fill */
        }

        #experiments-sidebar .card-title {
            padding: 0.75rem 1.25rem; /* Match summary padding */
            margin-bottom: 0;
            border-bottom: 1px solid var(--border-color);
        }

        #experiments-sidebar hr {
            margin: 0; /* Remove margin from hr */
        }

        #experiment_list {
            padding: 0.5rem 0; /* Add some vertical padding to the list */
        }

        #experiment_list details {
            margin-bottom: 0; /* Remove margin between project details */
            border: none;
        }

        #experiment_list summary {
            padding: 0.3rem 0.75rem; /* Smaller padding for project summaries */
            font-size: 0.9rem;
            background-color: transparent;
            border-bottom: none;
        }

        #experiment_list summary:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        #experiment_list .project-content {
            padding: 0 0 0 1rem; /* Indent project content */
            gap: 0.2rem; /* Smaller gap */
        }

        #experiment_list .list-group-item {
            border: none; /* Remove borders from list items */
            padding: 0.3rem 0.75rem; /* Smaller padding for experiment items */
            font-size: 0.85rem;
            background-color: transparent;
        }

        #experiment_list .list-group-item:hover {
            background-color: rgba(0, 0, 0, 0.03); /* Subtle hover for items */
        }

        #experiment_list .list-group-item button {
            padding: 0.2rem 0.5rem; /* Smaller buttons */
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <div class="row g-3 flex-grow-1">
            <div class="col-md-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <h1 class="card-title">Aetheria Lab</h1>
                        
                        <div id="status" class="mb-2">Conectando...</div>
                        <div id="stepCounter" class="text-muted mb-3">Paso: 0</div>
                        
                        <hr>
                        
                        <details open class="mb-3">
                            <summary class="h5">Visualizaci贸n</summary>
                            <div class="details-content">
                                <label for="viz_select" class="form-label">Tipo de Visualizaci贸n:</label>
                                <select id="viz_select" onchange="sendVizChange()" class="form-select">
                                    <optgroup label="An谩lisis de Grid">
                                        <option value="density" title="Muestra la densidad de probabilidad total en cada celda.">Densidad</option>
                                        <option value="state_change" title="Visualiza la magnitud del cambio entre el estado actual y el anterior.">Magnitud del Cambio</option>
                                        <option value="channels" title="Mapea los primeros 3 canales complejos a los colores RGB.">Canales RGB</option>
                                        <option value="aggregate_phase" title="Muestra la fase agregada de los estados cu谩nticos en cada celda.">Fase Agregada</option>
                                        <option value="fft" title="Aplica la Transformada R谩pida de Fourier 2D a la densidad para mostrar patrones de frecuencia espacial.">Transformada de Fourier 2D</option>
                                    </optgroup>
                                    <optgroup label="An谩lisis Temporal y Estad铆stico">
                                        <option value="spacetime_slice" title="Muestra una 'rebanada' del espacio-tiempo, generalmente la fila central del grid a lo largo del tiempo.">Diagrama Espacio-Tiempo</option>
                                        <option value="spacetime_cube" title="Visualizaci贸n 3D de la evoluci贸n de la densidad en el tiempo, formando un 'cubo'.">Cubo Espacio-Tiempo</option>
                                        <option value="poincare" title="Gr谩fico de recurrencia que muestra la densidad en el paso 't' vs. la densidad en el paso 't+1'.">Gr谩fico de Poincar茅</option>
                                        <option value="density_histogram" title="Distribuci贸n de frecuencias de los valores de densidad en el grid.">Histograma de Densidad</option>
                                    </optgroup>
                                </select>
                            </div>
                        </details>
                        
                        <details open class="mb-3">
                            <summary class="h5">Controles de Ejecuci贸n</summary>
                            <div class="details-content">
                                <div class="d-grid gap-2 mb-2">
                                    <div class="row g-2">
                                        <div class="col">
                                            <button id="pause_btn" onclick="sendCommand({scope: 'sim', command: 'pause'})" disabled class="btn btn-warning w-100">革 Pausar</button>
                                        </div>
                                        <div class="col">
                                            <button id="resume_btn" onclick="sendCommand({scope: 'sim', command: 'resume'})" disabled class="btn btn-success w-100">讹 Reanudar</button>
                                        </div>
                                    </div>
                                    <button id="reset_btn" onclick="handleReset()" disabled class="btn btn-info"> Resetear Simulaci贸n</button>
                                    <button id="start_sim_btn" onclick="showExperimentSelection()" class="btn btn-primary">讹 Iniciar Simulaci贸n</button>
                                    <button id="stop_sim_btn" onclick="stopSimulation()" disabled class="btn btn-danger"> Detener Simulaci贸n</button>
                                </div>
                            </div>
                        </details>

                        <details open class="mb-3">
                            <summary class="h5">Configuraci贸n del Experimento</summary>
                            <div class="details-content">
                                <div class="mb-3">
                                    <label for="exp_name" class="form-label">Nombre Experimento:</label>
                                    <input type="text" id="exp_name" value="NuevoExperimento" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="train_model_type" class="form-label">Tipo Modelo:</label>
                                    <select id="train_model_type" class="form-select">
                                        <option value="unet">U-Net (Est谩ndar)</option>
                                        <option value="unet_unitary">U-Net (Unitario)</option>
                                        <option value="mlp">MLP</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="hidden_channels" class="form-label">Canales Ocultos:</label>
                                    <input type="number" id="hidden_channels" value="32" min="1" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="training_grid_size" class="form-label">Tama帽o de Grilla (Entrenamiento):</label>
                                    <input type="number" id="training_grid_size" value="64" min="16" step="16" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="learning_rate" class="form-label">Tasa de Aprendizaje:</label>
                                    <input type="number" id="learning_rate" value="0.000001" step="0.000001" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="episodes" class="form-label">Episodios:</label>
                                    <input type="number" id="episodes" value="2000" min="1" class="form-control">
                                </div>
                                <div class="d-grid gap-2">
                                    <button onclick="startTraining()" class="btn btn-primary"> Iniciar Entrenamiento</button>
                                    <button onclick="stopTraining()" class="btn btn-danger"> Detener Entrenamiento</button>
                                    <button onclick="refreshCheckpoints()" class="btn btn-secondary"> Refrescar Modelos</button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </div> <!-- End of controls column -->
            
            <div class="col-md-3">
                <div id="experiments-sidebar" class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Explorador de Experimentos</h5>
                        <hr>
                        <div id="experiment_list" class="list-group flex-grow-1 overflow-auto">
                            <!-- Experiment items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 d-flex flex-column g-3">
                <div id="viewer" class="card shadow-sm text-center flex-grow-1">
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <canvas id="main_canvas" width="512" height="512" class="img-fluid"></canvas>
                    </div>
                </div>



                <div id="data-training-panel" class="card shadow-sm flex-grow-1">
                    <div class="card-body d-flex flex-column">
                        <details open class="mb-3">
                            <summary class="h5">M茅tricas Globales</summary>
                            <div class="details-content">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Entrop铆a (Grid):</span>
                                        <span id="metric_entropy" class="fw-bold">...</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Densidad Media:</span>
                                        <span id="metric_mean_density" class="fw-bold">...</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Varianza Densidad:</span>
                                        <span id="metric_variance" class="fw-bold">...</span>
                                    </li>
                                </ul>
                            </div>
                        </details>

                        <details open class="mb-3">
                            <summary class="h5">Configuraci贸n de Simulaci贸n</summary>
                            <div class="details-content">
                                <ul id="sim_config_display" class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Modelo:</span>
                                        <span id="sim_config_model" class="fw-bold">N/A</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Tama帽o Grilla:</span>
                                        <span id="sim_config_grid_size" class="fw-bold">N/A</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Dim. Estado (D):</span>
                                        <span id="sim_config_d_state" class="fw-bold">N/A</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Arquitectura:</span>
                                        <span id="sim_config_arch" class="fw-bold">N/A</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Dispositivo:</span>
                                        <span id="sim_config_device" class="fw-bold">N/A</span>
                                    </li>
                                </ul>
                            </div>
                        </details>

                        <details class="mb-3">
                            <summary class="h5">Pesos del Modelo (Pr贸ximamente)</summary>
                            <div class="details-content">
                                <p class="text-muted">Aqu铆 se mostrar谩n visualizaciones o estad铆sticas de los pesos del modelo cargado.</p>
                            </div>
                        </details>

                        <details open class="mb-3">
                            <summary class="h5">Log de Entrenamiento</summary>
                            <div class="details-content">
                                <pre id="training-log" class="bg-light p-2 rounded border"></pre>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        // --- ESTADO PRINCIPAL Y CONEXIN ---
        const canvas = document.getElementById('main_canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const stepCounterEl = document.getElementById('stepCounter');
        const vizSelect = document.getElementById('viz_select');
        const trainingLog = document.getElementById('training-log');

        const simConfigModel = document.getElementById('sim_config_model');
        const simConfigGridSize = document.getElementById('sim_config_grid_size');
        const simConfigDState = document.getElementById('sim_config_d_state');
        const simConfigArch = document.getElementById('sim_config_arch');
        const simConfigDevice = document.getElementById('sim_config_device');
        const experimentSelectionModalElement = document.getElementById('experiment_selection_modal');
        const experimentList = document.getElementById('experiment_list');
        
        const proto = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const WEBSOCKET_URL = `${proto}//${host}/ws`;
        
        let ws; 
        const img = new Image();
        let availableCheckpoints = []; // To store fetched checkpoints

        img.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };

        function connect() {
            console.log("Intentando conectar a:", WEBSOCKET_URL);
            statusEl.textContent = `Conectando a ${WEBSOCKET_URL}...`;
            ws = new WebSocket(WEBSOCKET_URL);

            ws.onopen = () => {
                console.log("Conectado al servidor AETHERIA.");
                statusEl.textContent = "Conectado";
                statusEl.className = "text-success"; // Bootstrap class
                sendVizChange(); 
                sendViewportChange();
                sendCommand({ scope: 'lab', command: 'refresh_checkpoints' }); // Request checkpoints on connect
            };

            ws.onclose = () => {
                console.log("Desconectado del servidor. Reintentando en 3s...");
                statusEl.textContent = "Desconectado. Reintentando...";
                statusEl.className = "text-danger"; // Bootstrap class
                setTimeout(connect, 3000);
            };

            ws.onerror = (err) => {
                console.error("Error de WebSocket:", err);
                statusEl.textContent = "Error de conexi贸n.";
                statusEl.className = "text-danger"; // Bootstrap class
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'sim_update') {
                        stepCounterEl.textContent = `Paso: ${data.step} (Tipo: ${data.frame_type})`;
                        if (vizSelect.value !== data.frame_type) {
                            vizSelect.value = data.frame_type;
                        }
                        img.src = data.image_data;

                        if (data.metrics) {
                            document.getElementById('metric_entropy').textContent = data.metrics.entropy.toFixed(4);
                            document.getElementById('metric_mean_density').textContent = data.metrics.mean_density.toFixed(4);
                            document.getElementById('metric_variance').textContent = data.metrics.variance.toFixed(4);
                        }
                    } else if (data.type === 'init' || data.type === 'checkpoints') {
                        availableCheckpoints = data.checkpoints; // Store checkpoints
                        populateExperimentList(availableCheckpoints); // Populate the modal list
                        if (data.sim_config) {
                            updateSimConfigDisplay(data.sim_config);
                        }
                    } else if (data.type === 'training_log') {
                        trainingLog.textContent += data.data + '\n';
                        trainingLog.scrollTop = trainingLog.scrollHeight;
                    } else if (data.type === 'sim_status') {
                        updateSimConfigDisplay(data.config || {});
                        if (data.status === 'running') {
                            updateSimulationControls(true, false);
                        } else if (data.status === 'stopped') {
                            updateSimulationControls(false, false);
                        } else if (data.status === 'paused') {
                            updateSimulationControls(true, true);
                        } else if (data.status === 'resumed') {
                            updateSimulationControls(true, false);
                        } else if (data.status === 'reset') { 
                            updateSimulationControls(false, false); 
                            stepCounterEl.textContent = `Paso: 0`; 
                        }
                    } else if (data.type === 'status') {
                        trainingLog.textContent += `--- ${data.data} ---\n`;
                        trainingLog.scrollTop = trainingLog.scrollHeight;
                    } else if (data.type === 'error') {
                        trainingLog.textContent += `ERROR: ${data.data}\n`;
                        trainingLog.scrollTop = trainingLog.scrollHeight;
                    }

                } catch (e) {
                    console.error("Error procesando mensaje:", e, event.data);
                }
            };
        }

        function sendCommand(cmd) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(cmd));
            } else {
                console.warn("No se pudo enviar el comando, WebSocket no est谩 abierto.");
            }
        }
        
        function sendVizChange() {
            const vizType = vizSelect.value;
            sendCommand({ scope: 'sim', command: "set_viz", args: { type: vizType } });
        }
        
        function handleReset() {
            viewport.x = 0;
            viewport.y = 0;
            viewport.width = 1;
            viewport.height = 1;
            sendCommand({scope: 'sim', command: 'reset'});
        }

        // Modified to populate the modal list with grouped checkpoints
        function populateExperimentList(groupedCheckpoints) {
            experimentList.innerHTML = ''; // Clear previous list
            
            // Option for random initial state
            const randomOption = document.createElement('div');
            randomOption.className = 'list-group-item d-flex justify-content-between align-items-center';
            randomOption.innerHTML = `
                <span>(Estado Inicial Aleatorio)</span>
                <button onclick="selectExperiment('')" class="btn btn-sm btn-primary">Seleccionar</button>
            `;
            experimentList.appendChild(randomOption);

            // Sort project names alphabetically for consistent display
            const projectNames = Object.keys(groupedCheckpoints).sort();

            projectNames.forEach(projectName => {
                const projectDetails = document.createElement('details');
                projectDetails.className = 'mb-2'; // Add margin-bottom for spacing
                projectDetails.open = true; // Keep projects open by default
                projectDetails.innerHTML = `<summary class="list-group-item list-group-item-action active">${projectName}</summary>`;
                
                const projectContent = document.createElement('div');
                projectContent.className = 'list-group list-group-flush border-top-0'; // For potential styling
                
                // Sort checkpoints within each project by name
                const checkpointsInProject = groupedCheckpoints[projectName].sort();

                checkpointsInProject.forEach(model => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <span>${model}</span>
                        <button onclick="selectExperiment('${model}')" class="btn btn-sm btn-outline-primary">Seleccionar</button>
                    `;
                    projectContent.appendChild(item);
                });
                
                projectDetails.appendChild(projectContent);
                experimentList.appendChild(projectDetails);
            });
        }

        function updateSimConfigDisplay(config) {
            simConfigModel.textContent = config.model_path || 'N/A';
            simConfigGridSize.textContent = config.grid_size || 'N/A';
            simConfigDState.textContent = config.d_state || 'N/A';
            simConfigArch.textContent = config.model_architecture || 'N/A';
            simConfigDevice.textContent = config.device || 'N/A';
        }

        const pauseBtn = document.getElementById('pause_btn');
        const resumeBtn = document.getElementById('resume_btn');
        const resetBtn = document.getElementById('reset_btn');
        const startSimBtn = document.getElementById('start_sim_btn');
        const stopSimBtn = document.getElementById('stop_sim_btn');

        function updateSimulationControls(isRunning, isPaused) {
            startSimBtn.disabled = isRunning;
            stopSimBtn.disabled = !isRunning;
            pauseBtn.disabled = !isRunning || isPaused;
            resumeBtn.disabled = !isRunning || !isPaused;
            resetBtn.disabled = !isRunning;

            if (isRunning) {
                statusEl.className = "text-primary"; // Bootstrap class for running
                statusEl.textContent = isPaused ? "Simulaci贸n Pausada" : "Simulaci贸n Corriendo";
            } else {
                statusEl.className = "text-danger"; // Bootstrap class for stopped
                statusEl.textContent = "Simulaci贸n Detenida";
            }
        }

        // Original startSimulation now takes modelPath
        function startSimulation(modelPath) {
            sendCommand({ scope: 'sim', command: 'start', args: { model_path: modelPath } });
            updateSimulationControls(true, false); // Optimistic update
        }

        function stopSimulation() {
            sendCommand({ scope: 'sim', command: 'stop' });
            updateSimulationControls(false, false); // Optimistic update
        }

        function startTraining() {
            const expName = document.getElementById('exp_name').value;
            const modelType = document.getElementById('train_model_type').value;
            const hiddenChannels = parseInt(document.getElementById('hidden_channels').value);
            const trainingGridSize = parseInt(document.getElementById('training_grid_size').value); 
            const lr = parseFloat(document.getElementById('learning_rate').value);
            const episodes = parseInt(document.getElementById('episodes').value);

            sendCommand({ 
                scope: 'lab', 
                command: 'start_training', 
                args: { 
                    name: expName, 
                    model: modelType, 
                    hidden_channels: hiddenChannels, 
                    training_grid_size: trainingGridSize, 
                    lr: lr, 
                    episodes: episodes 
                } 
            });
            trainingLog.textContent = ''; // Limpiar log al iniciar
        }

        function stopTraining() {
            sendCommand({ scope: 'lab', command: 'stop_training' });
        }

        function refreshCheckpoints() {
            sendCommand({ scope: 'lab', command: 'refresh_checkpoints' });
        }

        // New functions for experiment selection modal
        function showExperimentSelection() {
            // Ensure checkpoints are loaded, if not, request them
            if (availableCheckpoints.length === 0) {
                sendCommand({ scope: 'lab', command: 'refresh_checkpoints' });
            } else {
                populateExperimentList(availableCheckpoints);
            }
        }



        function selectExperiment(modelPath) {
            startSimulation(modelPath);
        }

        connect();
    </script>

    <script>
        // --- LGICA DE PAN Y ZOOM ---
        const viewport = { x: 0, y: 0, width: 1, height: 1 };
        const panning = { active: false, startX: 0, startY: 0 };
        const ZOOM_SENSITIVITY = 0.001;

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        const sendViewportChange = debounce(() => {
            sendCommand({ scope: 'sim', command: 'set_viewport', args: { viewport: viewport } });
        }, 100);

        canvas.addEventListener('mousedown', (e) => {
            panning.active = true;
            panning.startX = e.clientX;
            panning.startY = e.clientY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!panning.active) return;
            const dx = e.clientX - panning.startX;
            const dy = e.clientY - panning.startY;
            viewport.x -= (dx / canvas.clientWidth) * viewport.width;
            viewport.y -= (dy / canvas.clientHeight) * viewport.height;
            panning.startX = e.clientX;
            panning.startY = e.clientY;
            sendViewportChange();
        });

        const stopPanning = () => { panning.active = false; };
        canvas.addEventListener('mouseup', stopPanning);
        canvas.addEventListener('mouseleave', stopPanning);

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const mouseNormX = mouseX / canvas.clientWidth;
            const mouseNormY = mouseY / canvas.clientHeight;

            const zoomAmount = e.deltaY * ZOOM_SENSITIVITY;
            const zoomFactor = 1 + zoomAmount;
            
            const newWidth = viewport.width * zoomFactor;
            const newHeight = viewport.height * zoomFactor;

            if (newWidth < 0.001 || newWidth > 50) {
                return;
            }

            const focalX = viewport.x + mouseNormX * viewport.width;
            const focalY = viewport.y + mouseNormY * viewport.height;

            viewport.width = newWidth;
            viewport.height = newHeight;
            viewport.x = focalX - mouseNormX * newWidth;
            viewport.y = focalY - mouseNormY * newHeight;

            sendViewportChange();
        });
    </script>
</body>
</html>